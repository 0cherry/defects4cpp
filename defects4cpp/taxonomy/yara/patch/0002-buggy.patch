From bed0e4f74c0f63a8d21620a1f8cddf8751cb5740 Mon Sep 17 00:00:00 2001
From: haku <gentlebuuny@gmail.com>
Date: Thu, 8 Jul 2021 15:15:16 +0900
Subject: [PATCH] buggy

---
 libyara/rules.c | 22 ++++++++++------------
 1 file changed, 10 insertions(+), 12 deletions(-)

diff --git a/libyara/rules.c b/libyara/rules.c
index 81bdc17c..448062c7 100644
--- a/libyara/rules.c
+++ b/libyara/rules.c
@@ -483,16 +483,10 @@ YR_API int yr_rules_get_stats(
   if (match_list_lengths == NULL)
     return ERROR_INSUFFICIENT_MEMORY;
 
-  memset(stats, 0, sizeof(YR_RULES_STATS));
-
-  yr_rules_foreach(rules, rule)
-  {
-    stats->rules++;
-    yr_rule_strings_foreach(rule, string)
-      stats->strings++;
-  }
-
   stats->ac_tables_size = rules->ac_tables_size;
+  stats->ac_matches = 0;
+  stats->rules = 0;
+  stats->strings = 0;
 
   for (i = 0; i < rules->ac_tables_size; i++)
   {
@@ -519,9 +513,6 @@ YR_API int yr_rules_get_stats(
     }
   }
 
-  if (c == 0)
-    return ERROR_SUCCESS;
-
   // sort match_list_lengths in increasing order for computing percentiles.
   qsort(match_list_lengths, c, sizeof(match_list_lengths[0]), _uint32_cmp);
 
@@ -542,6 +533,13 @@ YR_API int yr_rules_get_stats(
 
   yr_free(match_list_lengths);
 
+  yr_rules_foreach(rules, rule)
+  {
+    stats->rules++;
+    yr_rule_strings_foreach(rule, string)
+      stats->strings++;
+  }
+
   return ERROR_SUCCESS;
 }
 
-- 
2.25.1

